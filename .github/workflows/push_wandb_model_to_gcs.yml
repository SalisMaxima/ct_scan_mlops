name: Upload W&B Model Artifact to GCS

on:
  workflow_dispatch:
    inputs:
      wandb_artifact:
        description: "W&B artifact path (e.g., entity/project/artifact:alias)"
        required: true
        type: string
      artifact_file:
        description: "Relative file path inside the artifact (e.g., model.pt)"
        required: true
        default: "model.pt"
        type: string
      gcs_bucket:
        description: "Destination GCS bucket name (no gs:// prefix)"
        required: true
        type: string
      gcs_object_path:
        description: "Destination object path in bucket (e.g., models/model.pt)"
        required: true
        default: "models/model.pt"
        type: string

jobs:
  upload_model:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Auth to GCP
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install W&B CLI
        run: uv tool install wandb

      - name: Download artifact and upload model to GCS
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          WANDB_ARTIFACT: ${{ inputs.wandb_artifact }}
          ARTIFACT_FILE: ${{ inputs.artifact_file }}
          GCS_BUCKET: ${{ inputs.gcs_bucket }}
          GCS_OBJECT_PATH: ${{ inputs.gcs_object_path }}
        run: |
          set -euo pipefail

          echo "Downloading W&B artifact: $WANDB_ARTIFACT"
          uv tool run wandb artifact get "$WANDB_ARTIFACT" --root ./wandb_artifacts

          ART_DIR=$(find ./wandb_artifacts -maxdepth 1 -mindepth 1 -type d | head -n 1)
          if [ -z "$ART_DIR" ]; then
            echo "No artifact directory found under ./wandb_artifacts"
            exit 1
          fi

          MODEL_FILE_PATH=$(find "$ART_DIR" -path "*/$ARTIFACT_FILE" -print -quit)
          if [ -z "$MODEL_FILE_PATH" ]; then
            echo "Artifact file not found: $ARTIFACT_FILE"
            echo "Available files:" && find "$ART_DIR" -type f
            exit 1
          fi

          echo "Uploading $MODEL_FILE_PATH to gs://$GCS_BUCKET/$GCS_OBJECT_PATH"
          gsutil cp "$MODEL_FILE_PATH" "gs://$GCS_BUCKET/$GCS_OBJECT_PATH"

          echo "âœ“ Upload complete"
