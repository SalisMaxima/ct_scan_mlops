name: Model Registry Workflow

# Triggered by W&B Model Registry webhook via repository_dispatch
# See: https://skaftenicki.github.io/dtu_mlops/s5_continuous_integration/cml/
on:
  repository_dispatch:
    types: [staging]
  workflow_dispatch:
    inputs:
      model_path:
        description: "W&B model artifact path (e.g., entity/project/model:alias)"
        required: true
        type: string

jobs:
  test-model:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          uv sync --all-extras --dev
          uv pip list

      - name: Determine model path
        id: model
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "path=${{ github.event.client_payload.model_path }}" >> $GITHUB_OUTPUT
          else
            echo "path=${{ github.event.inputs.model_path }}" >> $GITHUB_OUTPUT
          fi

      - name: Test model performance
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          # TODO: Implement W&B model registry testing
          # The ct_scan_mlops.test_model module was never created.
          # For now, download the model and run analysis.cli diagnose.
          echo "Model testing step placeholder for: ${{ steps.model.outputs.path }}"
          echo "Skipping automated testing — manual validation required before promotion."

      - name: Promote to production
        if: success()
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          uv run python -m ct_scan_mlops.promote_model \
            --model-path "${{ steps.model.outputs.path }}"

      - name: Summary
        if: always()
        run: |
          echo "## Model Registry Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: \`${{ steps.model.outputs.path }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **Status**: ✅ Promoted to production" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ❌ Failed - model did not pass tests" >> $GITHUB_STEP_SUMMARY
          fi
