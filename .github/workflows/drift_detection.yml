name: Drift Detection

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  drift-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Auth to GCP
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Get Cloud Run service URL
        id: service
        run: |
          SERVICE_URL=$(gcloud run services describe ct-scan-api \
            --region=europe-west1 \
            --format='value(status.url)')
          echo "url=$SERVICE_URL" >> "$GITHUB_OUTPUT"

      - name: Check API health
        run: |
          curl -f --retry 3 --retry-delay 10 "${{ steps.service.outputs.url }}/health"

      - name: Run drift detection
        id: drift
        run: |
          RESPONSE=$(curl -sf "${{ steps.service.outputs.url }}/monitoring/drift?write_html=true" || echo '{}')
          echo "response=$RESPONSE" >> "$GITHUB_OUTPUT"

          DATASET_DRIFT=$(echo "$RESPONSE" | jq -r '.dataset_drift // "null"')
          SHARE_DRIFTED=$(echo "$RESPONSE" | jq -r '.share_drifted_columns // "0"')

          echo "dataset_drift=$DATASET_DRIFT" >> "$GITHUB_OUTPUT"
          echo "share_drifted=$SHARE_DRIFTED" >> "$GITHUB_OUTPUT"

          echo "Dataset drift: $DATASET_DRIFT"
          echo "Share drifted columns: $SHARE_DRIFTED"

      - name: Create issue on significant drift
        if: steps.drift.outputs.dataset_drift == 'true' && steps.drift.outputs.share_drifted > 0.3
        uses: actions/github-script@v7
        with:
          script: |
            const share = '${{ steps.drift.outputs.share_drifted }}';
            const pct = (parseFloat(share) * 100).toFixed(1);

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Data Drift Alert: ${pct}% of features drifted`,
              body: [
                '## Data Drift Detected',
                '',
                `- **Dataset drift:** ${{ steps.drift.outputs.dataset_drift }}`,
                `- **Share of drifted columns:** ${pct}%`,
                `- **Detected at:** ${new Date().toISOString()}`,
                `- **Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                '',
                '### Recommended Actions',
                '1. Review the drift report artifact from this workflow run',
                '2. Check recent prediction inputs for distribution changes',
                '3. Consider retraining the model if drift persists',
              ].join('\n'),
              labels: ['drift-alert', 'automated'],
            });

      - name: Download drift report from GCS
        if: always()
        continue-on-error: true
        run: |
          gsutil cp gs://dtu-mlops-data-482907_cloudbuild/drift/drift_report.html ./drift_report.html 2>/dev/null || true

      - name: Upload drift report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-report
          path: drift_report.html
          if-no-files-found: ignore
          retention-days: 30
