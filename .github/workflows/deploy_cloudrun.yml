name: Deploy API to Cloud Run

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ vars.GAR_LOCATION }}-docker.pkg.dev --quiet

      # Download model from W&B and upload to GCS
      # WANDB_MODEL_ARTIFACT should be set in GitHub variables with format: entity/project/artifact:version
      - name: Download model from W&B and upload to GCS
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          set -euo pipefail

          # Install uv if not already available and determine its path
          if command -v uv &> /dev/null; then
            UV_BIN="$(command -v uv)"
          else
            curl -LsSf https://astral.sh/uv/install.sh | sh
            UV_BIN="$HOME/.local/bin/uv"
          fi

          rm -rf models/ && mkdir models
          "$UV_BIN" tool run wandb artifact get ${{ vars.WANDB_MODEL_ARTIFACT }} --root models/

          MODEL_PATH="models/model.pt"
          GCS_URI="gs://${{ vars.GCS_BUCKET }}/models/model.pt"

          if [ ! -f "$MODEL_PATH" ]; then
            echo "ERROR: Expected model file not found at $MODEL_PATH" >&2
            exit 1
          fi

          # Compute local MD5 checksum in base64 (matches GCS md5 metadata)
          LOCAL_MD5="$(openssl md5 -binary "$MODEL_PATH" | base64)"

          # Check if model already exists in GCS and if checksum matches
          REMOTE_MD5=""
          if gsutil -q stat "$GCS_URI"; then
            echo "Model already exists in GCS, checking checksum..."
            REMOTE_MD5="$(gsutil stat "$GCS_URI" | awk '/Hash \(md5\):/ {print $3}')"
          fi

          if [ -n "${REMOTE_MD5:-}" ] && [ "$REMOTE_MD5" = "$LOCAL_MD5" ]; then
            echo "Matching model already present in GCS. Skipping upload."
          else
            echo "Uploading model to GCS..."
            gsutil cp "$MODEL_PATH" "$GCS_URI"

            echo "Verifying uploaded model checksum..."
            UPLOADED_MD5="$(gsutil stat "$GCS_URI" | awk '/Hash \(md5\):/ {print $3}')"
            if [ "$UPLOADED_MD5" != "$LOCAL_MD5" ]; then
              echo "ERROR: Uploaded model checksum ($UPLOADED_MD5) does not match local checksum ($LOCAL_MD5)." >&2
              exit 1
            fi
          fi

      - name: Build & push image (GitHub runner)
        run: |
          IMAGE_URI="${{ vars.GAR_LOCATION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.GAR_REPO }}/ct-scan-api:${{ github.sha }}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          docker build -f dockerfiles/api.cloudrun.dockerfile -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ct-scan-api \
            --image "$IMAGE_URI" \
            --region "${{ vars.GAR_LOCATION }}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "CONFIG_PATH=/app/configs/config.yaml,MODEL_PATH=/gcs/models/model.pt" \
            --add-volume name=models,type=cloud-storage,bucket=${{ vars.GCS_BUCKET }} \
            --add-volume-mount volume=models,mount-path=/gcs
