name: Train on Vertex AI

on:
  workflow_dispatch:
    inputs:
      model_choice:
        description: 'Model to train'
        required: false
        default: 'cnn'
        type: choice
        options:
          - cnn
          - resnet18
      max_epochs:
        description: 'Maximum training epochs'
        required: false
        default: '50'
        type: string
      wandb_mode:
        description: 'W&B logging mode'
        required: false
        default: 'online'
        type: choice
        options:
          - online
          - offline
          - disabled
      accelerator:
        description: 'Training accelerator'
        required: false
        default: 'cpu'
        type: choice
        options:
          - cpu
          - gpu-t4

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GAR_LOCATION }}
  GAR_REPO: ${{ vars.GAR_REPO }}

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Set image config
        id: config
        run: |
          ACCELERATOR="${{ inputs.accelerator || 'cpu' }}"
          if [ "$ACCELERATOR" == "gpu-t4" ]; then
            echo "dockerfile=dockerfiles/train_cuda.dockerfile" >> $GITHUB_OUTPUT
            echo "image_suffix=cuda" >> $GITHUB_OUTPUT
            echo "machine_type=n1-standard-8" >> $GITHUB_OUTPUT
            echo "accelerator_type=NVIDIA_TESLA_T4" >> $GITHUB_OUTPUT
            echo "accelerator_count=1" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
            echo "image_suffix=cpu" >> $GITHUB_OUTPUT
            echo "machine_type=n1-standard-8" >> $GITHUB_OUTPUT
            echo "accelerator_type=" >> $GITHUB_OUTPUT
            echo "accelerator_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Build & push image
        run: |
          IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/ct-scan-train-${{ steps.config.outputs.image_suffix }}:${{ github.sha }}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

          # Create cloudbuild.yaml for custom dockerfile
          cat > cloudbuild.yaml <<EOF
          steps:
            - name: 'gcr.io/cloud-builders/docker'
              args: ['build', '-t', '$IMAGE_URI', '-f', '${{ steps.config.outputs.dockerfile }}', '.']
          images:
            - '$IMAGE_URI'
          EOF

          gcloud builds submit . --config=cloudbuild.yaml

      - name: Create Vertex AI job config
        run: |  # pragma: allowlist secret
          cat > job.yaml <<EOF
          displayName: ct-scan-train-${{ github.sha }}
          jobSpec:
            workerPoolSpecs:
            - replicaCount: 1
              machineSpec:
                machineType: ${{ steps.config.outputs.machine_type }}
          EOF

          # Add GPU config if requested
          if [ -n "${{ steps.config.outputs.accelerator_type }}" ]; then
            cat >> job.yaml <<EOF
                acceleratorType: ${{ steps.config.outputs.accelerator_type }}
                acceleratorCount: ${{ steps.config.outputs.accelerator_count }}
          EOF
          fi

          # Add container spec
          cat >> job.yaml <<EOF
              containerSpec:
                imageUri: ${IMAGE_URI}
                args:
                  - "model=${{ inputs.model_choice || 'cnn' }}"
                  - "train.max_epochs=${{ inputs.max_epochs || '50' }}"
                  - "wandb.mode=${{ inputs.wandb_mode || 'online' }}"
                env:
                  - name: WANDB_PROJECT
                    value: "CT_Scan_MLOps"
                  - name: WANDB_ENTITY
                    value: "mathiashl-danmarks-tekniske-universitet-dtu"
          EOF

          # Add secret reference for WANDB_API_KEY (only if not disabled)  # pragma: allowlist secret
          if [ "${{ inputs.wandb_mode || 'online' }}" != "disabled" ]; then
            cat >> job.yaml <<EOF
                secretEnvVariables:
                  - secretName: projects/${{ env.PROJECT_ID }}/secrets/wandb-api-key/versions/latest  # pragma: allowlist secret
                    envName: WANDB_API_KEY
          EOF
          fi

          echo "=== Generated job.yaml ==="
          cat job.yaml

      - name: Run Vertex training
        run: |
          gcloud ai custom-jobs create \
            --region=${{ env.REGION }} \
            --config=job.yaml

      - name: Show monitoring link
        run: |
          echo "::notice::Monitor training at: https://console.cloud.google.com/vertex-ai/training/custom-jobs?project=${{ env.PROJECT_ID }}"
