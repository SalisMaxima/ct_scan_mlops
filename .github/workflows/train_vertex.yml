name: Train on Vertex AI

on:
  workflow_dispatch:
    inputs:
      model_choice:
        description: 'Model to train'
        required: false
        default: 'cnn'
        type: choice
        options:
          - cnn
          - resnet18
      max_epochs:
        description: 'Maximum training epochs'
        required: false
        default: '50'
        type: string
      wandb_mode:
        description: 'W&B logging mode'
        required: false
        default: 'online'
        type: choice
        options:
          - online
          - offline
          - disabled
      accelerator:
        description: 'Training accelerator'
        required: false
        default: 'cpu'
        type: choice
        options:
          - cpu
          - gpu-t4

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GAR_LOCATION }}
  GAR_REPO: ${{ vars.GAR_REPO }}

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
          
      - uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Set image config
        id: config
        run: |
          ACCELERATOR="${{ inputs.accelerator || 'cpu' }}"
          if [ "$ACCELERATOR" == "gpu-t4" ]; then
            echo "dockerfile=dockerfiles/train_cuda.dockerfile" >> $GITHUB_OUTPUT
            echo "image_suffix=cuda" >> $GITHUB_OUTPUT
            echo "machine_type=n1-standard-8" >> $GITHUB_OUTPUT
            echo "accelerator_type=NVIDIA_TESLA_T4" >> $GITHUB_OUTPUT
            echo "accelerator_count=1" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
            echo "image_suffix=cpu" >> $GITHUB_OUTPUT
            echo "machine_type=n1-standard-8" >> $GITHUB_OUTPUT
            echo "accelerator_type=" >> $GITHUB_OUTPUT
            echo "accelerator_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Auth Docker to Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build & push image
        run: |
          IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/ct-scan-train-${{ steps.config.outputs.image_suffix }}:${{ github.sha }}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

          docker build -t "$IMAGE_URI" -f "${{ steps.config.outputs.dockerfile }}" .
          docker push "$IMAGE_URI"

      - name: Create Vertex AI job config
        run: |
          # Create the base worker pool spec
          # We remove 'displayName' and 'jobSpec' keys here so the file 
          # is a valid WorkerPoolSpec list for the --config flag.
          cat > job.yaml <<EOF
          workerPoolSpecs:
            - replicaCount: 1
              machineSpec:
                machineType: ${{ steps.config.outputs.machine_type }}
          EOF

          # Append GPU config if requested
          if [ -n "${{ steps.config.outputs.accelerator_type }}" ]; then
            cat >> job.yaml <<EOF
                acceleratorType: ${{ steps.config.outputs.accelerator_type }}
                acceleratorCount: ${{ steps.config.outputs.accelerator_count }}
          EOF
          fi

          # Append Container Spec (Logic for args and env vars)
          cat >> job.yaml <<EOF
              containerSpec:
                imageUri: ${IMAGE_URI}
                args:
                  - "model=${{ inputs.model_choice || 'cnn' }}"
                  - "train.max_epochs=${{ inputs.max_epochs || '50' }}"
                  - "wandb.mode=${{ inputs.wandb_mode || 'online' }}"
                env:
                  - name: WANDB_PROJECT
                    value: "CT_Scan_MLOps"
                  - name: WANDB_ENTITY
                    value: "mathiashl-danmarks-tekniske-universitet-dtu"
          EOF

          # Append Secret Env Vars (only if W&B is not disabled)
          if [ "${{ inputs.wandb_mode || 'online' }}" != "disabled" ]; then
            cat >> job.yaml <<EOF
                secretEnvVariables:
                  - secretName: projects/${{ env.PROJECT_ID }}/secrets/wandb-api-key/versions/latest
                    envName: WANDB_API_KEY
          EOF
          fi

          echo "=== Generated job.yaml ==="
          cat job.yaml

      - name: Run Vertex training
        run: |
          # 1. Fetch W&B API Key from Secret Manager (if needed)
          WANDB_API_KEY_VAL=""
          MODE="${{ inputs.wandb_mode || 'online' }}"
          
          if [ "$MODE" != "disabled" ]; then
            echo "Fetching W&B API Key from Secret Manager..."
            WANDB_API_KEY_VAL=$(gcloud secrets versions access latest --secret="wandb-api-key" --project="${{ env.PROJECT_ID }}")
          fi

          # 2. Create the job spec configuration
          # We inject the fetched key directly into the 'env' section
          cat > job.yaml <<EOF
          workerPoolSpecs:
          - replicaCount: 1
            machineSpec:
              machineType: n1-standard-8
            containerSpec:
              imageUri: ${IMAGE_URI}
              args:
                - "model=${{ inputs.model_choice || 'cnn' }}"
                - "train.max_epochs=${{ inputs.max_epochs || '50' }}"
                - "wandb.mode=$MODE"
              env:
                - name: WANDB_PROJECT
                  value: "CT_Scan_MLOps"
                - name: WANDB_ENTITY
                  value: "mathiashl-danmarks-tekniske-universitet-dtu"
                - name: WANDB_API_KEY
                  value: "$WANDB_API_KEY_VAL"
          EOF

          # 3. Submit the job
          gcloud ai custom-jobs create \
            --region=${{ vars.GAR_LOCATION }} \
            --display-name="ct-scan-train-$(date +%Y%m%d-%H%M%S)" \
            --config=job.yaml

      - name: Show monitoring link
        run: |
          echo "::notice::Monitor training at: https://console.cloud.google.com/vertex-ai/training/custom-jobs?project=${{ env.PROJECT_ID }}"
