name: DVC Workflow

permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  pull_request:
    paths:
      - "**/*.dvc"
      - ".dvc/**"
      - "data/**"
  workflow_dispatch:

jobs:
  data-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          uv sync --all-extras --dev
          uv pip list

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Pull data via DVC
        run: |
          uv run dvc pull
          echo "Data directory contents:"
          ls -la data/raw/ 2>/dev/null | head -20 || echo "data/raw/ not found"

      - name: Generate dataset samples
        run: |
          uv run python -m ct_scan_mlops.analysis.diagnose_data --save-images
          echo "Generated files:"
          ls -la outputs/reports/data_diagnostics/ 2>/dev/null || echo "Output directory not created"

      - name: Add sample image to summary
        run: |
          image_path="outputs/reports/data_diagnostics/ct_scan_images.png"

          {
            echo "## CT Scan Sample Images"
            echo
            if [ -f "$image_path" ]; then
              encoded=$(base64 -w 0 "$image_path")
              echo "![ct-scan-samples](data:image/png;base64,${encoded})"
            else
              echo "Sample image not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Set up CML
        if: github.event_name == 'pull_request'
        uses: iterative/setup-cml@v3

      - name: Post PR comment with sample image
        if: github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          image_path="outputs/reports/data_diagnostics/ct_scan_images.png"

          {
            echo "## CT Scan Sample Images"
            echo
            if [ -f "$image_path" ]; then
              echo "![ct-scan-samples](${image_path})"
            else
              echo "Sample image not found."
            fi
          } > report.md

          cml comment create report.md
