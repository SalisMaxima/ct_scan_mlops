name: DVC Workflow

on:
  push:
    paths:
      - "**/*.dvc"
      - ".dvc/**"
      - "data/**"
  workflow_dispatch:

jobs:
  data-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync --dev

      - name: Generate dataset samples
        run: uv run python -m ct_scan_mlops.dataset --save-images

      - name: Add sample image to summary
        run: |
          python - <<'PY'
          import base64
          import os

          image_path = "reports/figures/ct_scan_images.png"
          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")

          if not summary_path:
              raise SystemExit("GITHUB_STEP_SUMMARY not set")

          with open(summary_path, "a", encoding="utf-8") as summary:
              summary.write("## CT Scan Sample Images\n\n")
              if os.path.exists(image_path):
                  with open(image_path, "rb") as image_file:
                      encoded = base64.b64encode(image_file.read()).decode("utf-8")
                  summary.write(f"![ct-scan-samples](data:image/png;base64,{encoded})\n")
              else:
                  summary.write("Sample image not found.\n")
          PY
